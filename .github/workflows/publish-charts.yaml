name: publish-charts

on:
  push:
    tags:
      - "v*.*.*"

permissions:
  contents: read
  packages: write

jobs:
  publish:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Helm
        uses: azure/setup-helm@v4
        with:
          version: v3.15.4

      - name: Set up Python (required by ct)
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Set up chart-testing
        uses: helm/chart-testing-action@v2

      - name: Determine changed charts (vs main)
        id: list-changed
        run: |
          set -euo pipefail
          git fetch origin main:refs/remotes/origin/main
          changed="$(ct list-changed --config .ct.yaml --target-branch main)"
          echo "changed_charts<<EOF" >> "$GITHUB_OUTPUT"
          echo "$changed" >> "$GITHUB_OUTPUT"
          echo "EOF" >> "$GITHUB_OUTPUT"

      - name: Log in to GHCR (OCI)
        run: |
          set -euo pipefail
          echo "${{ secrets.GITHUB_TOKEN }}" | helm registry login ghcr.io -u "${{ github.actor }}" --password-stdin

      - name: Package & push changed charts
        env:
          OCI_REPO: oci://ghcr.io/${{ github.repository_owner }}/${{ github.event.repository.name }}
        run: |
          set -euo pipefail

          charts="${{ steps.list-changed.outputs.changed_charts }}"
          if [ -z "$charts" ]; then
            echo "No changed charts detected; nothing to publish."
            exit 0
          fi

          mkdir -p .dist

          echo "$charts" | while read -r chart; do
            [ -n "$chart" ] || continue

            echo "Packaging: $chart"
            pkg="$(helm package "$chart" --destination .dist | awk '{print $NF}')"

            echo "Pushing $pkg to $OCI_REPO"
            helm push "$pkg" "$OCI_REPO"
          done
